name: Build RustDesk custom (no secure_tcp)

on:
  workflow_dispatch:
  push:
    paths:
      - "src/**"
      - ".github/workflows/**"

env:
  # 这三条你在仓库 Settings -> Secrets -> Actions 里建过
  DEFAULT_RENDEZVOUS_SERVER: ${{ secrets.DEFAULT_RENDEZVOUS_SERVER }}
  DEFAULT_RELAY_SERVER: ${{ secrets.DEFAULT_RELAY_SERVER }}
  DEFAULT_RS_PUB_KEY: ${{ secrets.DEFAULT_RS_PUB_KEY }}

jobs:
  linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive    # rustdesk 必须拉子模块 :contentReference[oaicite:2]{index=2}

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config cmake git curl \
            libssl-dev libgtk-3-dev libxcb-shape0-dev libxcb-xfixes0-dev \
            libxkbcommon-dev libasound2-dev

      - name: Install vcpkg and C libs
        run: |
          git clone https://github.com/microsoft/vcpkg.git $HOME/vcpkg
          $HOME/vcpkg/bootstrap-vcpkg.sh
          # rustdesk linux 需要的这几包，文档有写 :contentReference[oaicite:3]{index=3}
          $HOME/vcpkg/vcpkg install libvpx libyuv opus aom
          echo "VCPKG_ROOT=$HOME/vcpkg" >> $GITHUB_ENV

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build (Linux)
        env:
          VCPKG_ROOT: ${{ env.VCPKG_ROOT }}
          RENDEZVOUS_SERVER: ${{ secrets.DEFAULT_RENDEZVOUS_SERVER }}
          RELAY_SERVER: ${{ secrets.DEFAULT_RELAY_SERVER }}
          RS_PUB_KEY: ${{ secrets.DEFAULT_RS_PUB_KEY }}
        run: |
          # 如果你在代码里读这些 env，可以在这里再写进文件
          cargo build --release
          mkdir -p artifacts/linux
          cp target/release/rustdesk artifacts/linux/

      - name: Upload linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-linux
          path: artifacts/linux/

  windows:
    runs-on: windows-2022
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install LLVM/Clang (for bindgen)
        run: choco install -y llvm --version=15.0.2

      - name: Install vcpkg + deps
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg $env:USERPROFILE\vcpkg
          & $env:USERPROFILE\vcpkg\bootstrap-vcpkg.bat
          $pkgs = @('libvpx:x64-windows-static','libyuv:x64-windows-static','opus:x64-windows-static','aom:x64-windows-static')
          & $env:USERPROFILE\vcpkg\vcpkg.exe install $pkgs
          "VCPKG_ROOT=$env:USERPROFILE\vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Download sciter.dll (desktop UI)  # rustdesk Windows 要这个 :contentReference[oaicite:4]{index=4}
        run: |
          New-Item -ItemType Directory -Force -Path target\release | Out-Null
          Invoke-WebRequest -UseBasicParsing -Uri https://raw.githubusercontent.com/c-smile/sciter-sdk/master/bin.win/x64/sciter.dll -OutFile target\release\sciter.dll

      - name: Build (Windows)
        env:
          VCPKG_ROOT: ${{ env.VCPKG_ROOT }}
        run: |
          cargo build --release --target x86_64-pc-windows-msvc
          mkdir artifacts
          copy target\x86_64-pc-windows-msvc\release\rustdesk.exe artifacts\rustdesk.exe
          copy target\release\sciter.dll artifacts\sciter.dll

      - name: Upload windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows
          path: artifacts\
